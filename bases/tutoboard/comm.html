<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>La communications - Doc ENAC Robotique</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Doc ENAC Robotique</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="les-communications"><a class="header" href="#les-communications">Les communications</a></h1>
<h3 id="introduction-au-serial"><a class="header" href="#introduction-au-serial">Introduction au serial</a></h3>
<p>Pour communiquer entre le pc et une carte électronique, un moyen souvent utilisé est la <a href="https://fr.wikipedia.org/wiki/Transmission_s%C3%A9rie">transmission Série</a> ou Serial. C’est un protocole de communication qui a l’avantage d’être simple et surtout, facilement programmable. Le principe est qu'un seul bus de données relie deux appareils et permet la communication en envoyant un par un les trames de données. <strong>En gros on les relie par un fil...</strong></p>
<h4 id="communication-avec-le-pc"><a class="header" href="#communication-avec-le-pc">Communication avec le pc</a></h4>
<p>Comment utiliser le serial pour débugger, sans rentrer du tout dans les détails :</p>
<p>Pour utiliser le serial il faut modifier le fichier <code>platformio.ini</code> et y rajouter l'instruction <code>monitor_speed = baudrate</code>.</p>
<img src="../../images/pio_ini.png" height="300px" width="auto">
<p>Ensuite pour accéder au moniteur série il suffit de cliquer sur l'icone en bas de l'écran :</p>
<img src="../../images/tuto_board_serial.png" height="100px" width="auto">
<blockquote>
<p>Si vous faisiez le tuto <em>Lecture d'un potentiomètre</em>, pas besoin d'aller plus loin dans l'immédiat. Vous devriez pouvoir lire des messages du moniteur.</p>
</blockquote>
<p>Avec maintenant un peu plus de détails :</p>
<p>La manière la plus courante pour communiquer entre un PC et une carte embarquée est via les ports USB des 2 objets en question.
Ainsi, repérez le port mini usb sur la nucleo, puis branchez y l’adaptateur USB-microUSB jusqu’au PC.
Qu’est-ce qu’il se passe sur le PC ?
Rien d’apparent, mais sous linux, les périphériques sont situés dans le dossier <code>/dev/tty</code>.</p>
<p>Dans le terminal faites <code>ls /dev/tty*</code></p>
<p>Vous devriez avoir avec cette commande plein de résultats. Maintenant débranchez l'usb et refaite la commande. Vous devrier en avoir un de moins. Si vous jouez au 7 différences vous devrier en trouver un du genre <code>ttyACMX</code>. Moi par exemple j'ai  <code>ttyACM0</code>. C’est notre nucleo ! Ensuite, on utilise la bilbiothèque Arduino qui utilise les standards de <code>print</code> du C/C++.</p>
<p>Pour configurer le serial on rajoute dans le setup <code>Serial.begin(baudrate);</code>, ou baudrate et le nombre de <a href="../../introductions/lexique.html">BAUD</a>, dans le cas présent cela signifie le nombre de bits par seconde. Ici utilisez la valeur <code>115200</code>.</p>
<p>Maintenant pour envoyer un message dans le moniteur série on peut faire <code>Serial.print("Salut les enaciens !");</code> dans le setup.</p>
<p>Pour formater un message on à plusieur solutions.</p>
<ul>
<li>On peut spécifier la Base à utiliser ou l'arrondi pour un nombre par exemple:</li>
</ul>
<pre><code class="language-cpp">Serial.print(78, BIN) donne "1001110"
Serial.print(78, OCT) donne "116"
Serial.print(78, DEC) donne "78"
Serial.print(78, HEX) donne "4E"
Serial.print(1.23456, 0) donne "1"
Serial.print(1.23456, 2) donne "1.23"
Serial.print(1.23456, 4) donne "1.2346"
</code></pre>
<ul>
<li>On peut mélanger du texte et des nombres avec <code>printf()</code>.</li>
</ul>
<p>Par exemple pour votre led à la page précédente nous avions fait</p>
<pre><code class="language-cpp">Serial.printf("potar = %d, led = %d \n", potar_value, led_value);
</code></pre>
<p><code>%d</code> sert à signifier qu'un type <code>int</code> va venir se mettre là,  puis on le passe en argument c'est <code>potar_value</code>. Il faut respecter l'ordre dans lequel on l'écrit. On peut utiliser <code>%f</code> pour un float et il en existe d'autres, cherchez <strong>Format Specifiers</strong> sur internet.</p>
<h3 id="uart"><a class="header" href="#uart">UART</a></h3>
<p>L'Universal Asynchronous Receiver Transmitter ou <a href="https://fr.wikipedia.org/wiki/UART">UART</a> est un composant matériel qui permet l'échange de données entre deux appareils utilisant le protocole série.</p>
<div style="display: flex; align-items: flex-start;">
<img src="../../images/uart.webp" height="150px" width="auto">
<div style="padding-left: 30px;">
L'UART est simple à mettre en œuvre car il ne nécessite que deux fils pour la communication (TX pour transmettre et RX pour recevoir), en plus d'une masse commune (GND). Le TX et RX sont désigné du point de vue de l'appareil. Dans notre pratique il y'a souvent un 4e fil pour l'alimentation.
</div>
</div>
<p>La transmission est <strong>asynchrone</strong> c'est à dire qu'il n'y a pas de signal d'horloge pour synchroniser les messages. Au lieu de cela on utilise un bit de Start et un ou deux bits de Stop pour chaque donnée.
Il ya aussi optionellement un bit de parité utilisé pour la détection d'erreurs placé en amont des bits de stop. La vitesse de transmission est en Baud.</p>
<img src="../../images/Constitution_trame_uart.png" height="100px" width="auto" >
<h4 id="communiquer-avec-le-moniteur-série"><a class="header" href="#communiquer-avec-le-moniteur-série">Communiquer avec le moniteur série</a></h4>
<p>L'UART est ce qui nous permet de communiquer entre le pc et le microcontrôleur. En fait lorsque vous utilisez le <code>Serial</code> avec la carte tuto vous faîtes déjà de l'UART ! Mais maintenant vous voulez aussi aller dans l'autre sens.
Avant le setup et le loop ajouter <code>String msg;</code> c'est la variable qui va stocker notre message. Puis dans le loop :</p>
<pre><code class="language-cpp">if (Serial.available()) // Vérifie s'il y a des données disponibles
{ 
    msg = Serial.readString();  // lit la valeur qu'on a envoyé et l'enregistre dans la variable msg
    Serial.println(msg);  //Affiche le texte contenu dans msg sur le moniteur
}
</code></pre>
<p>Accedez au moniteur série et cliquez dans le terminal. Vous pouvez maintenant écrire ici. Le texte ne s'affiche pas quand vous écrivez, mais la réponse de la carte s'affichera.</p>
<img src="../../images/Moniteur_serie.png" height="200px" width="auto">
<h4 id="faire-communiquer-deux-appareils"><a class="header" href="#faire-communiquer-deux-appareils">Faire communiquer deux appareils</a></h4>
<p>En pratique vous voudrez surement faire communiquer plusieurs cartes. Dans notre cas, on fait très souvent communiquer une raspberry pi avec une STM32. Dans ce cas il faut donc du code des deux cotés. Pour le coté raspberry vous allez utiliser votre pc et python, ça reviens exactement au même. On ne va pas entrer dans les détails coté python alors copiez collez le code ci dessous. Il faut peut être changer le <code>/dev/ttyACM0</code> par celui que vous avez. Vous pourrier avoir besoin de la bibliothèque <code>pyserial</code> faite <code>pip install pyserial</code> dans votre terminal. Et si vous n'avez pas pip, intstallez pip.</p>
<pre><code class="language-py">import serial
from time import time
if __name__ == "__main__":
    ser = serial.Serial('/dev/ttyACM0', 115200)  # open serial port
    print(f"\nTutoboard sur le port: {ser.name} vitesse : {ser.baudrate}") # check which port was really used
    i = 0
    add = 1
    t = time()
    while True:
        if i == 9 :
            add = -1
        if i == 0:
            add = 1
        if time() - t &gt; 0.1 : 
            i = i + add
            message = str(i) + "\n" 
            ser.write(bytes(message, "ascii")) # write a string
            t = time()
        msg = ser.read()
        print(f"Je lis : {msg.hex()}\n")
        
        # Si vous utilisez write() dans le bas niveau
        # msg = ser.read()
        # print(f"Je lis : {msg.hex()}\n")

</code></pre>
<p>Maintenant du coté bas niveau :</p>
<p>Pour rendre ça un peu plus interactif on va faire clignoter les leds en fonction de ce que nous dis le haut niveau et dire au haut niveau la valeur du potar qui gère l'autre led.</p>
<p>Il nous faut d'abord un <strong>buffer</strong> c'est à dire un espace mémoire qui va contenir la donnée entrante. Nous allons communiquer des messages au format <a href="https://fr.wikipedia.org/wiki/American_Standard_Code_for_Information_Interchange">ASCII</a>. Chaque caractère est codé sur 7 bits. Ici on s'attend à recevoir 2 octets (ou bytes en anglais), le premier étant un entier entre 0 et 9 et le second <code>\n</code>permet d'indiquer la fin du message. En embarqué on est plutôt du genre à vouloir toujours connaître la taille des données que l'on manipule. La mémoire étant limitée on voudrait éviter des dépassements de mémoire (ou Buffer Overflow). On va donc rajouter <code>#define BUFFER_SIZE 2</code> au début de notre code.</p>
<p>On va créer des fonctions.</p>
<ul>
<li>Pour la récéption :</li>
</ul>
<pre><code class="language-cpp">int receive()
{
    if (Serial.available() &gt; 0)  // Vérifie s'il y a des données disponibles
    {
        char buffer[BUFFER_SIZE]; // On crée notre buffer pour stocker la donnée
        Serial.readBytesUntil('\n', buffer, BUFFER_SIZE); // Lit les données jusqu'a \n avec un maximum d'octet dicté par BUFFER_SIZE

        // on converti la chaine de carractère en l'entier équivalent 
        // pour pouvoir faire des opérations Attention ça ne marche pas avec les lettres !
        char *output;
        int val = strtol(buffer, &amp;output, 10); // base décimale
        return val;
    }
  return -1;
}
</code></pre>
<p>Attention à faire la différence entre le caractère <code>char</code> qu'est <code>'\n'</code> et la chaine de carractère <code>"\n"</code> stocké sous forme de liste de <code>char</code>. La fonction peut être placée avant ou après le loop. Si elle est placée après, le compilateur vous dira qu'elle n'existe pas. Il faut alors rajouter <code>int receive();</code> en amont.</p>
<ul>
<li>Envoi d'un message :</li>
</ul>
<p>La c'est facile, comme on l'a dit plus tôt il suffit de faire un <code>print</code> pour écrire sur le serial.</p>
<pre><code class="language-cpp">void send(int val)
{ 
  Serial.println(val);
  delay(100);
  // Serial.write((byte)val); // ne mettez pas print et write en même temps !
}
</code></pre>
<p>Dans certain cas on peut aussi vouloir envoyer des données binaires, on utilise alors <code>write</code>. Par contre il faut changer les deux dernières lignes du code python par :</p>
<pre><code class="language-py">msg = ser.read()
print(f"Je lis : {msg.hex()}\n")
</code></pre>
<p>Votre loop devrait tout simplement ressembler à ça :</p>
<pre><code class="language-cpp">void loop() {
  
  // On lis le potar, on envoie sa valeur dans le serial et on pilote la led 
  int potar_value = analogRead(POT);
  int led1_value = map(potar_value, 0, 1023, 0, 255);  
  analogWrite(LED1, led1_value);
  send(led1_value);

  // On lit dans le serial la valeur a appliquer à la led
  int msg = receive();
  if (msg!=-1)
  {
    int led2_value = map(msg, 0, 9, 0, 255);
    analogWrite(LED2, led2_value);
  }
}
</code></pre>
<p>Et voilà vous pouvez téléverser. Ensuite dans votre terminal faîtes <code>python3 tuto_uart.py</code> pour lancer le programme python. Vous devriez lire la valeur du potar dans le terminal et voir l'une des led clignoter lentement sur la carte.</p>
<blockquote>
<p>Attention vous ne pourrez pas ouvrir le moniteur série en même temps que le code python tourne. Vous ne pouvez pas accéder deux fois au même port série. Vous risquez d'avoir des instabilités voire directement une erreur.</p>
</blockquote>
<ul>
<li>(TODO) Visualiser l'UART sur l'analyseur logique.</li>
</ul>
<h3 id="todo-i2c"><a class="header" href="#todo-i2c">(TODO) I2C</a></h3>
<blockquote>
<p>Note : Récement il y'a l'emergence de l'I3C un successeur de l'i2C et rétro-compatible avec les matériels I2C. Ça à l'air intéréssant.</p>
</blockquote>
<ul>
<li>(TODO) Visualiser les trames sur l'analyseur logique</li>
</ul>
<h3 id="communication-avec-la-attiny-1616-"><a class="header" href="#communication-avec-la-attiny-1616-">Communication avec la attiny 1616 :</a></h3>
<!-- [TODO : mettre un easter egg sur l’attiny] -->
<!-- Explication du code :

Vous recevez des caractères étranges et vides de sens, pourquoi ?

-> Baud rate
Il faut le passer à 57600[ou autre] pour lire ce qu’on a caché dans l’attiny. -->
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../bases/tutoboard/bases.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../bases/tutoboard/attiny.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../bases/tutoboard/bases.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../bases/tutoboard/attiny.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
